---
# This test assumes a locally running Nexus3 app.
# The easiest way to acheive that is via `docker run -it -p 8081:8081 sonatype/nexus3

- name: 'Enable Nexus RUT'
  hosts: local
  vars:
    nexus_api_base_path: '/service/rest/v1'
    nexus_user: admin
    nexus_password: 'admin123'  ## ADMIN Password
    nexus_protocol: http
    nexus_url: 'localhost:8081'
    nexus_server_poll_retries: 100
    nexus_server_poll_delay_in_seconds: 10
  tasks:
  - name: Start nexus container
    command: 'docker run -d --name nexus_token_test -p 8081:8081 sonatype/nexus3'
  - name: "Ensure the Nexus Server is Up"
    uri:
      url: "{{ nexus_protocol }}://{{ nexus_url }}/service/metrics/healthcheck"
      method: GET
      status_code: 200
      user: "{{ nexus_user }}"
      password: "{{ nexus_password }}"
      force_basic_auth: yes
    register: nexus_server_check_result
    until: nexus_server_check_result is success
    retries: '{{ nexus_server_poll_retries }}'
    delay: '{{ nexus_server_poll_delay_in_seconds }}'
  - name: Alway try our tests
    block:
    - name: Update admin password
      include_role: 
        name: config-nexus-user
      vars:
        target_nexus_email: 'admin@example.com'
        target_nexus_user: 'admin'
        target_nexus_password: 'MyTestPassword'
        target_nexus_roles: "nx-admin"
    - name: Verify admin password was changed
      uri:
        url: "{{ nexus_protocol }}://{{ nexus_url }}/service/metrics/healthcheck"
        method: GET
        status_code: 200
        validate_certs: false
        user: "admin"
        password: "MyTestPassword"
        force_basic_auth: yes
    - name: Create new user
      include_role: 
        name: config-nexus-user
      vars:
        nexus_password: 'MyTestPassword'  ## ADMIN Password
        target_nexus_email: 'newuser@example.com'
        target_nexus_user: 'newuser'
        target_nexus_password: 'NewUserTestPassword'
        target_nexus_roles: "nx-anonymous,nx-admin"
    - name: Verify new user was created
      uri:
        url: "{{ nexus_protocol }}://{{ nexus_url }}/service/metrics/healthcheck"
        method: GET
        status_code: 200
        validate_certs: false
        user: "newuser"
        password: "NewUserTestPassword"
        force_basic_auth: yes
    - name: Alter new user but leave groups the same
      include_role: 
        name: config-nexus-user
      vars:
        nexus_password: 'MyTestPassword'  ## ADMIN Password
        target_nexus_email: 'newuser@example.com'
        target_nexus_user: 'newuser'
        target_nexus_password: 'SomeOtherPassword'
    - name: Verify new user still works
      uri:
        url: "{{ nexus_protocol }}://{{ nexus_url }}/service/metrics/healthcheck"
        method: GET
        status_code: 200
        validate_certs: false
        user: "newuser"
        password: "SomeOtherPassword"
        force_basic_auth: yes
  - name: Clean up test containers
    always:
    - name: Stop Nexus test container
      command: 'docker kill nexus_token_test'
    - name: Delete Nexus test container
      command: 'docker rm nexus_token_test'