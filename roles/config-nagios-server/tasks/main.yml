# Copyright 2018 Red Hat, Inc.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

- name: Setup hostgroup directories
  file:
    path: /etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}
    state: directory
    mode: 0755
  with_items: "{{groups['nagios-targets']}}"

- name: Setup common hostgroup configuration
  template:
    src: common.cfg.j2 
    dest: /etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/common.cfg
    owner: root
    group: root
    mode: 0644 
  with_items: "{{groups['nagios-targets']}}"

- name: Setup the hosts in the hostgroup configuration
  template:
    src: host.cfg.j2 
    dest: /etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/{{hostvars[item]['inventory_hostname_short']}}.cfg
    owner: root
    group: root
    mode: 0644 
  with_items: "{{groups['nagios-targets']}}"

- name: Add common hostgroup configuration to master nagios configuration file
  lineinfile:
    dest: /etc/nagios/nagios.cfg
    regexp: "^cfg_file=/etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/common.cfg"
    line: "cfg_file=/etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/common.cfg"
  with_items: "{{groups['nagios-targets']}}"

- name: Add host configuration to master nagios configuration file
  lineinfile:
    dest: /etc/nagios/nagios.cfg
    regexp: "^cfg_file=/etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/{{hostvars[item]['inventory_hostname_short']}}.cfg"
    line: "cfg_file=/etc/nagios/objects/{{hostvars[item]['hostgroup_name']}}/{{hostvars[item]['inventory_hostname_short']}}.cfg"
  with_items: "{{groups['nagios-targets']}}"

- name: Restart nagios
  service:
    name: nagios
    state: restarted

