---

- name: "Set facts"
  set_fact:
    rh_sso_host: "192.168.16.3"
    rh_sso_port: 8080
    rh_sso_port_list:
      - 8080/tcp
      - 9990/tcp

- name: "Requesting Access Token"
  uri:
    url: "http://{{ rh_sso_host }}:{{ rh_sso_port }}/auth/realms/master/protocol/openid-connect/token"
    method: POST
    body_format: form-urlencoded
    body:
      username: "{{ sso_admin_user }}"
      password: "{{ sso_admin_pass }}"
      grant_type: "password"
      client_id: "admin-cli"
  register: rh_sso_token

- name: "Retrieve user to delete"
  uri:
    url: "http://{{ rh_sso_host }}:{{ rh_sso_port }}/auth/admin/realms/master/users"
    method: GET
    headers:
      Authorization: "Bearer {{ rh_sso_token.json.access_token }}"
  register: user_to_delete

- name: "Filter user ID to delete"
  set_fact:
    user_id: "{{ user_to_delete.json | json_query(user_temp) }}"
  vars:
    user_temp: "[? username=='atrodrig-7'].{id:id}"
  register: user_temp_id

- name: "Delete user"
  uri:
    url: "http://{{ rh_sso_host }}:{{ rh_sso_port }}/auth/admin/realms/master/users/{{ user_temp_id.id }}"
    method: DELETE
#    body: "{{ realm_json }}"
#    body_format: json
#    src: "roles/identity-management/manage-rh-sso-identities/templates/manage-user.json"
#    remote_src: "no"
    status_code: 201, 409
    headers:
      Content-type: "application/json"
      Accept: "application/json"
      Authorization: "Bearer {{ rh_sso_token.json.access_token }}"
  register: rh_sso_realm_create
