---

- name: "Get Red Hat SSO access token"
  include_tasks: access-token.yml

- name: "Retrieve group to delete"
  uri:
    url: "http://{{ rh_sso_host }}:{{ rh_sso_port }}/auth/admin/realms/master/groups"
    method: GET
    headers:
      Authorization: "Bearer {{ rh_sso_token.json.access_token }}"
  register: group_to_delete

- name: "Filter group ID to delete"
  set_fact:
    group_id: "{{ group_to_delete.json | json_query(group_filter) }}"
  vars:
    group_filter: "[? name=='{{ group_data.group_name }}'].{id:id}"
  when: group_to_delete 

- name: "Delete group"
  uri:
    url: "http://{{ rh_sso_host }}:{{ rh_sso_port }}/auth/admin/realms/master/groups/{{ group_id[0].id }}"
    method: DELETE
    status_code: 204
    headers:
      Authorization: "Bearer {{ rh_sso_token.json.access_token }}"
  when: group_to_delete is defined
