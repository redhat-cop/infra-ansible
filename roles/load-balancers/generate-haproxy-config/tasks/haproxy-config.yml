---

- name: 'Populate the common config portion for HAproxy'
  template:
    src: lb_common.j2
    dest: '{{ haproxy_temp_dir }}/0001_lb.cfg'

- name: 'Configure and Populate LB Frontends'
  template:
    src: lb_frontend.j2
    dest: '{{ haproxy_temp_dir }}/0002_lb_{{ fe.lb_name }}_{{ fe.lb_host_vip }}_{{ fe.lb_host_port }}.cfg'
  loop_control:
    loop_var: fe
  loop: "{{ lb_config.frontends|flatten(levels=1) }}"

- name: 'Configure and Populate LB Backends'
  template:
    src: lb_backend.j2
    dest: '{{ haproxy_temp_dir }}/0003_lb.cfg'

- name: 'Populate the stats page config'
  vars:
    page_config: "{{ lb_config.stats_page }}"
  template:
    src: lb_http_stats.j2
    dest: '{{ haproxy_temp_dir }}/0004_lb.cfg'
  when:
  - lb_config.stats_page is defined
  - lb_config.stats_page.enabled is defined
  - lb_config.stats_page.enabled

- name: 'Assemble the final HAproxy config file'
  assemble:
    src: '{{ haproxy_temp_dir }}'
    dest: '{{ haproxy_temp_file }}'
