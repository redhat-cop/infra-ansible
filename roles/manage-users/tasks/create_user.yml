--- 
  - name: Create IPA user
    ipa_user:
      ipa_host: "{{ ipa_host | default(ansible_host)}}"
      ipa_user: "{{ ipa_admin_user }}"
      ipa_pass: "{{ ipa_admin_password }}"
      validate_certs: "{{ ipa_validate_certs | default(False) }}"
      givenname: "{{ item.first_name | trim }}"
      sn: "{{ item.last_name | trim }}"
      name: "{{ item.user_name | trim }}"
      mail: "{{ item.email | default('') }}"
# The addition of expiration date is a request that will be submitted upstream
#      expiration_date: "{{ this_user.expiration_date | default('') }}"
    with_items: "{{ users }}"
    register: the_user

  - name: "Display results of ipa_user loop"
    debug:
      var: item.user
      verbosity: 2
    with_items: "{{ the_user.results }}"

  - name: "Create password generation dataset"
    set_fact: 
       pwd_users: "{{ pwd_users | default([]) + [{'user_name': item.item.user_name,'generate': true, 'password': item.item.password|default('')}] }}"
    with_items: "{{ the_user.results }}"
    when:
      - item.user.has_password is defined
      - item.user.has_password == false

  - name: "Display results of pwd_user structure"
    debug:
      var: pwd_users
      verbosity: 2
    when: 
      - pwd_users is defined


