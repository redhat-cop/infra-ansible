---

- name: "Obtain current service accounts"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack user list --domain "default" -f yaml
  register: sa_list
  changed_when: False

- name: "Store away the yaml output"
  set_fact:
    sa_list_yaml: "{{ sa_list.stdout|from_yaml }}"

- name: "Create the Service Accounts"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack user create \
      --domain "{{ item.domain }}" \
      --password "{{ item.password }}" \
      "{{ item.name }}"
  with_items:
  - "{{ osp_serviceaccounts | get_remaining_items(sa_list_yaml, 'name', 'Name') }}"

- name: "Grant access to Servce Accounts"
  include: "sa-roles.yml"
  with_items:
  - "{{ osp_serviceaccounts }}"
  loop_control:
    loop_var: sa
