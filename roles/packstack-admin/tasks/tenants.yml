---

- name: "Obtain currently configured projects/tenants"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack project list -f yaml
  register: project_list

- name: "Store away the yaml output"
  set_fact:
    project_list_yaml: "{{ project_list.stdout|from_yaml }}"

- name: "Add projects / tenants"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack project create \
      --domain "{{ item.domain }}" \
      --description "{{ item.description }}" \
      --enable \
      "{{ item.name }}"
  with_items:
  - "{{ osp_projects | get_remaining_items(project_list_yaml, 'name', 'Name') }}"

- name: "Assign roles for users/projects"
  include: "tenant-roles.yml"
  with_items:
  - "{{ osp_projects }}"
  loop_control:
    loop_var: project

- name: "Update tenant quotas"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack quota set \
      --cores "{{ item.quota.vcpus }}" \
      --instances "{{ item.quota.instances }}" \
      --volumes "{{ item.quota.volumes }}" \
      --gigabytes "{{ item.quota.total_vol_size }}" \
      --ram "{{ item.quota.ram }}" \
      --secgroups "{{ item.quota.security_groups }}" \
      --secgroup-rules "{{ item.quota.security_group_rules }}" \
      --floating-ips "{{ item.quota.floating_ips }}" \
      --networks "{{ item.quota.networks }}" \
      --routers "{{ item.quota.routers }}" \
      --subnets "{{ item.quota.subnets }}" \
      "{{ item.name }}"
  with_items:
  - "{{ osp_projects }}"
  when:
  - item.quota is defined
