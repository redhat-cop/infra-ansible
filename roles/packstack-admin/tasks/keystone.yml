---

- name: "Get current LDAP domains"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack domain list -f json
  register: existing_domains

- name: "Store the target domain info (if found)"
  set_fact:
    existing_target_domain: "{{ item }}"
  when:
  - existing_domains is defined
  - item.Name == keystone_ldap.domain
  with_items:
  - "{{ existing_domains.stdout|from_json }}"

- name: "Create the LDAP domain"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack domain create --description "{{ keystone_ldap.domain }} Domain" --enable "{{ keystone_ldap.domain }}"
  when:
  - existing_target_domain is not defined

- name: "Add admins from the LDAP domain"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack role add --project admin --user "{{ item }}" --user-domain "{{ keystone_ldap.domain }}" admin
  with_items:
  - "{{ keystone_ldap.admins }}"
