---

- name: "Get current LDAP domains"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack domain list -f yaml
  register: domain_list
  changed_when: False

- name: "Store away the yaml output"
  set_fact:
    domain_list_yaml: "{{ domain_list.stdout|from_yaml }}"

- name: "Create the LDAP domain(s)"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack domain create \
      --description "{{ item.domain }} Domain" \
      --enable \
      "{{ item.domain }}"
  with_items:
  - "{{ keystone_ldap | get_remaining_items(domain_list_yaml, 'domain', 'Name') }}"

- name: "Restart keystone (httpd) to ensure config has been applied"
  service:
    name: httpd
    state: restarted

- name: "Wait a bit for keystone to catch up"
  pause:
    seconds: 15
