---

- name: "Obtain current images"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack image list -f yaml
  register: image_list
  changed_when: False

- name: "Store away the yaml output"
  set_fact:
    image_list_yaml: "{{ image_list.stdout|from_yaml }}"

- name: "Create the image"
  shell: >
    source {{ admin_keystonerc_file }};
    openstack image create \
      --{{ item.visibility }} \
      --file "{{ item.path }}" \
      "{{ item.name }}"
  with_items:
  - "{{ osp_default_images | get_remaining_items(image_list_yaml, 'name', 'Name') }}"
