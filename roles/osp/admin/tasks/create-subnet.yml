---

- name: "Build DNS nameservers command line options"
  set_fact:
    dns_nameservers: "{{ dns_nameservers | default('') + ' --dns-nameserver ' + item }}"
  with_items:
  - "{{ subnet.dns_nameservers }}"

- name: "Set up subnet"
  os_subnet:
    project: "{{ subnet.project }}"
    network_name: "{{ subnet.network_name }}"
    allocation_pool_start: "{{ subnet.allocation_pool_start }}"
    allocation_pool_end: "{{ subnet.allocation_pool_end }}"
    name: "{{ subnet.name }}"

  shell: >
    source {{ admin_keystonerc_file }};
    openstack subnet create \
      --project "{{ subnet.project }}" \
      --network "{{ subnet.network }}" \
      --allocation-pool "{{ subnet.allocation_pool }}" \
      {{ dns_nameservers }} \
      --{{ subnet.dhcp_option }} \
      --subnet-range "{{ subnet.subnet_range }}" \
      --gateway "{{ subnet.gateway }}" \
      "{{ subnet.name }}"
