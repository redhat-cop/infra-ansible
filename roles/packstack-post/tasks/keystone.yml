---

- name: "Configure the keystone parameters to allow for multiple domains"
  ini_file:
    path: "/etc/keystone/keystone.conf"
    section: "identity"
    option: "{{ item.key }}"
    value: "{{ item.value }}"
  with_items:
  - { key: 'domain_specific_drivers_enabled', value: 'true' }
  - { key: 'domain_config_dir', value: '/etc/keystone/domains' }
  notify: 'restart keystone'

- name: "Configure the openstack-dashboard parameters to allow for multiple domains"
  lineinfile:
    path: "/etc/openstack-dashboard/local_settings"
    regexp: '^{{ item.key}} ='
    line: '{{ item.key }} = {{ item.value }}'
  with_items:
  - { key: 'OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT', value: 'True' }
  - { key: 'OPENSTACK_KEYSTONE_DEFAULT_DOMAIN', value: '"{{ keystone_ldap.domain }}"' }
  notify: 'restart keystone'

- name: "Ensure target domain directory exists"
  file:
    path: "/etc/keystone/domains/"
    state: directory

- name: "Set SELinux boolean"
  seboolean:
    name: authlogin_nsswitch_use_ldap
    state: yes
    persistent: yes

- name: "Setup LDAP domain configuration"
  template:
    src: keystone_ldap.j2
    dest: "/etc/keystone/domains/keystone.{{ keystone_ldap.domain }}.conf"
  notify: 'restart keystone'
