
frontend {{ lb_frontend_name }}
    bind {{ lb_host_vip }}:{{ lb_host_port }}
{% if lb_ssl_enabled %}
    mode tcp

    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
{% endif %}

{% for entry in lb_entries %}
{% if entry.lb_port|string == lb_host_port|string %}
{% set lb_host = (entry.name | default(entry.lb_host)) | regex_replace('^\.', '') %}
{% if lb_ssl_enabled %}
    acl {{ lb_host }} req_ssl_sni -m end {{ entry.lb_host }}
{% else %}
    acl {{ lb_host }} hdr_sub(host) -i {{ entry.lb_host }}
{% endif %}
{% endif %}
{% endfor %}

{% for entry in lb_entries %}
{% if entry.lb_port|string == lb_host_port|string %}
{% set lb_host = (entry.name | default(entry.lb_host)) | regex_replace('^\.', '') %}
    use_backend {{ lb_host }}-{{ entry.lb_port }} if {{ lb_host }}
{% endif %}
{% endfor %}
